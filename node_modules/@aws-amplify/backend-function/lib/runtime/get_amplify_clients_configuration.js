import { NamingConverter } from '@aws-amplify/platform-core';
import { GetObjectCommand, NoSuchKey, S3Client, S3ServiceException, } from '@aws-sdk/client-s3';
const dataKeyNameContent = '_MODEL_INTROSPECTION_SCHEMA_KEY';
const dataBucketNameContent = '_MODEL_INTROSPECTION_SCHEMA_BUCKET_NAME';
const dataEndpointNameContent = '_GRAPHQL_ENDPOINT';
const isAmplifyClientEnv = (env) => {
    return ('AWS_ACCESS_KEY_ID' in env &&
        typeof env.AWS_ACCESS_KEY_ID === 'string' &&
        'AWS_SECRET_ACCESS_KEY' in env &&
        typeof env.AWS_SECRET_ACCESS_KEY === 'string' &&
        'AWS_SESSION_TOKEN' in env &&
        typeof env.AWS_SESSION_TOKEN === 'string' &&
        'AWS_REGION' in env &&
        typeof env.AWS_REGION === 'string' &&
        'AMPLIFY_DATA_DEFAULT_NAME' in env &&
        typeof env.AMPLIFY_DATA_DEFAULT_NAME === 'string');
};
/* eslint-enable @typescript-eslint/naming-convention */
const getResourceConfig = (env, modelIntrospectionSchema) => {
    return {
        API: {
            GraphQL: {
                endpoint: env.dataEndpoint,
                region: env.AWS_REGION,
                defaultAuthMode: 'iam',
                modelIntrospection: modelIntrospectionSchema,
            },
        },
    };
};
const getLibraryOptions = (env) => {
    return {
        Auth: {
            credentialsProvider: {
                getCredentialsAndIdentityId: async () => ({
                    credentials: {
                        accessKeyId: env.AWS_ACCESS_KEY_ID,
                        secretAccessKey: env.AWS_SECRET_ACCESS_KEY,
                        sessionToken: env.AWS_SESSION_TOKEN,
                    },
                }),
                clearCredentialsAndIdentityId: () => {
                    /* noop */
                },
            },
        },
    };
};
const extendEnv = (env, dataName) => {
    const bucketName = `${dataName}${dataBucketNameContent}`;
    const keyName = `${dataName}${dataKeyNameContent}`;
    const endpointName = `${dataName}${dataEndpointNameContent}`;
    if (!(bucketName in env &&
        keyName in env &&
        endpointName in env &&
        typeof env[bucketName] === 'string' &&
        typeof env[keyName] === 'string' &&
        typeof env[endpointName] === 'string')) {
        throw new Error(`The data environment variables are malformed. env=${JSON.stringify(env)}`);
    }
    const dataBucket = env[bucketName];
    const dataKey = env[keyName];
    const dataEndpoint = env[endpointName];
    return {
        ...env,
        dataBucket,
        dataKey,
        dataEndpoint,
    };
};
/**
 * Generate the `resourceConfig` and `libraryOptions` need to configure
 * Amplify for the data client in a lambda.
 *
 * Your function needs to be granted resource access on your schema for this to work
 * `a.schema(...).authorization((allow) => [a.resource(myFunction)])`
 * @param env - The environment variables for the data client
 * @returns An object containing the `resourceConfig` and `libraryOptions`
 */
export const getAmplifyDataClientConfig = async (env, s3Client) => {
    if (!s3Client) {
        s3Client = new S3Client();
    }
    if (env === null || typeof env !== 'object') {
        throw new Error(`Invalid environment variables: ${JSON.stringify(env)}`);
    }
    if (!isAmplifyClientEnv(env)) {
        return { resourceConfig: {}, libraryOptions: {} };
    }
    const dataName = new NamingConverter().toScreamingSnakeCase(env.AMPLIFY_DATA_DEFAULT_NAME);
    const extendedEnv = extendEnv(env, dataName);
    let modelIntrospectionSchema;
    try {
        const response = await s3Client.send(new GetObjectCommand({
            Bucket: extendedEnv.dataBucket,
            Key: extendedEnv.dataKey,
        }));
        const modelIntrospectionSchemaJson = await response.Body?.transformToString();
        modelIntrospectionSchema = JSON.parse(modelIntrospectionSchemaJson ?? '{}');
    }
    catch (caught) {
        if (caught instanceof NoSuchKey) {
            throw new Error('Error retrieving the schema from S3. Please confirm that your project has a `defineData` included in the `defineBackend` definition.');
        }
        else if (caught instanceof S3ServiceException) {
            throw new Error(`Error retrieving the schema from S3. You may need to grant this function authorization on the schema. ${caught.name}: ${caught.message}.`);
        }
        else {
            throw caught;
        }
    }
    const libraryOptions = getLibraryOptions(env);
    const resourceConfig = getResourceConfig(extendedEnv, modelIntrospectionSchema);
    return { resourceConfig, libraryOptions };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0X2FtcGxpZnlfY2xpZW50c19jb25maWd1cmF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3J1bnRpbWUvZ2V0X2FtcGxpZnlfY2xpZW50c19jb25maWd1cmF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM3RCxPQUFPLEVBQ0wsZ0JBQWdCLEVBQ2hCLFNBQVMsRUFDVCxRQUFRLEVBQ1Isa0JBQWtCLEdBQ25CLE1BQU0sb0JBQW9CLENBQUM7QUFFNUIsTUFBTSxrQkFBa0IsR0FBRyxpQ0FBaUMsQ0FBQztBQUM3RCxNQUFNLHFCQUFxQixHQUFHLHlDQUF5QyxDQUFDO0FBQ3hFLE1BQU0sdUJBQXVCLEdBQUcsbUJBQW1CLENBQUM7QUFvQnBELE1BQU0sa0JBQWtCLEdBQUcsQ0FBQyxHQUFXLEVBQXdCLEVBQUU7SUFDL0QsT0FBTyxDQUNMLG1CQUFtQixJQUFJLEdBQUc7UUFDMUIsT0FBTyxHQUFHLENBQUMsaUJBQWlCLEtBQUssUUFBUTtRQUN6Qyx1QkFBdUIsSUFBSSxHQUFHO1FBQzlCLE9BQU8sR0FBRyxDQUFDLHFCQUFxQixLQUFLLFFBQVE7UUFDN0MsbUJBQW1CLElBQUksR0FBRztRQUMxQixPQUFPLEdBQUcsQ0FBQyxpQkFBaUIsS0FBSyxRQUFRO1FBQ3pDLFlBQVksSUFBSSxHQUFHO1FBQ25CLE9BQU8sR0FBRyxDQUFDLFVBQVUsS0FBSyxRQUFRO1FBQ2xDLDJCQUEyQixJQUFJLEdBQUc7UUFDbEMsT0FBTyxHQUFHLENBQUMseUJBQXlCLEtBQUssUUFBUSxDQUNsRCxDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBZ0JGLHdEQUF3RDtBQUV4RCxNQUFNLGlCQUFpQixHQUFHLENBQ3hCLEdBQTZCLEVBQzdCLHdCQUFnQyxFQUNoQixFQUFFO0lBQ2xCLE9BQU87UUFDTCxHQUFHLEVBQUU7WUFDSCxPQUFPLEVBQUU7Z0JBQ1AsUUFBUSxF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USxHQUFHLE1BQU0sUUFBUSxDQUFDLElBQUksQ0FDbEMsSUFBSSxnQkFBZ0IsQ0FBQztZQUNuQixNQUFNLEVBQUUsV0FBVyxDQUFDLFVBQVU7WUFDOUIsR0FBRyxFQUFFLFdBQVcsQ0FBQyxPQUFPO1NBQ3pCLENBQUMsQ0FDSCxDQUFDO1FBQ0YsTUFBTSw0QkFBNEIsR0FDaEMsTUFBTSxRQUFRLENBQUMsSUFBSSxFQUFFLGlCQUFpQixFQUFFLENBQUM7UUFDM0Msd0JBQXdCLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsSUFBSSxJQUFJLENBQUMsQ0FBQztLQUM3RTtJQUFDLE9BQU8sTUFBTSxFQUFFO1FBQ2YsSUFBSSxNQUFNLFlBQVksU0FBUyxFQUFFO1lBQy9CLE1BQU0sSUFBSSxLQUFLLENBQ2Isc0lBQXNJLENBQ3ZJLENBQUM7U0FDSDthQUFNLElBQUksTUFBTSxZQUFZLGtCQUFrQixFQUFFO1lBQy9DLE1BQU0sSUFBSSxLQUFLLENBQ2IseUdBQXlHLE1BQU0sQ0FBQyxJQUFJLEtBQUssTUFBTSxDQUFDLE9BQU8sR0FBRyxDQUMzSSxDQUFDO1NBQ0g7YUFBTTtZQUNMLE1BQU0sTUFBTSxDQUFDO1NBQ2Q7S0FDRjtJQUVELE1BQU0sY0FBYyxHQUFHLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBRTlDLE1BQU0sY0FBYyxHQUFHLGlCQUFpQixDQUN0QyxXQUFXLEVBQ1gsd0JBQXdCLENBQ3pCLENBQUM7SUFFRixPQUFPLEVBQUUsY0FBYyxFQUFFLGNBQWMsRUFBeUIsQ0FBQztBQUNuRSxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBOYW1pbmdDb252ZXJ0ZXIgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQge1xuICBHZXRPYmplY3RDb21tYW5kLFxuICBOb1N1Y2hLZXksXG4gIFMzQ2xpZW50LFxuICBTM1NlcnZpY2VFeGNlcHRpb24sXG59IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XG5cbmNvbnN0IGRhdGFLZXlOYW1lQ29udGVudCA9ICdfTU9ERUxfSU5UUk9TUEVDVElPTl9TQ0hFTUFfS0VZJztcbmNvbnN0IGRhdGFCdWNrZXROYW1lQ29udGVudCA9ICdfTU9ERUxfSU5UUk9TUEVDVElPTl9TQ0hFTUFfQlVDS0VUX05BTUUnO1xuY29uc3QgZGF0YUVuZHBvaW50TmFtZUNvbnRlbnQgPSAnX0dSQVBIUUxfRU5EUE9JTlQnO1xuXG5leHBvcnQgdHlwZSBEYXRhQ2xpZW50RW52ID0ge1xuICAvKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbmFtaW5nLWNvbnZlbnRpb24gKi9cbiAgQVdTX0FDQ0VTU19LRVlfSUQ6IHN0cmluZztcbiAgQVdTX1NFQ1JFVF9BQ0NFU1NfS0VZOiBzdHJpbmc7XG4gIEFXU19TRVNTSU9OX1RPS0VOOiBzdHJpbmc7XG4gIEFXU19SRUdJT046IHN0cmluZztcbiAgQU1QTElGWV9EQVRBX0RFRkFVTFRfTkFNRTogc3RyaW5nO1xuICAvKiBlc2xpbnQtZW5hYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvbiAqL1xufSAmIFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xuXG50eXBlIERhdGFFbnZFeHRlbnNpb24gPSB7XG4gIGRhdGFCdWNrZXQ6IHN0cmluZztcbiAgZGF0YUtleTogc3RyaW5nO1xuICBkYXRhRW5kcG9pbnQ6IHN0cmluZztcbn07XG5cbnR5cGUgRXh0ZW5kZWRBbXBsaWZ5Q2xpZW50RW52ID0gRGF0YUNsaWVudEVudiAmIERhdGFFbnZFeHRlbnNpb247XG5cbmNvbnN0IGlzQW1wbGlmeUNsaWVudEVudiA9IChlbnY6IG9iamVjdCk6IGVudiBpcyBEYXRhQ2xpZW50RW52ID0+IHtcbiAgcmV0dXJuIChcbiAgICAnQVdTX0FDQ0VTU19LRVlfSUQnIGluIGVudiAmJlxuICAgIHR5cGVvZiBlbnYuQVdTX0FDQ0VTU19LRVlfSUQgPT09ICdzdHJpbmcnICYmXG4gICAgJ0FXU19TRUNSRVRfQUNDRVNTX0tFWScgaW4gZW52ICYmXG4gICAgdHlwZW9mIGVudi5BV1NfU0VDUkVUX0FDQ0VTU19LRVkgPT09ICdzdHJpbmcnICYmXG4gICAgJ0FXU19TRVNTSU9OX1RPS0VOJyBpbiBlbnYgJiZcbiAgICB0eXBlb2YgZW52LkFXU19TRVNTSU9OX1RPS0VOID09PSAnc3RyaW5nJyAmJlxuICAgICdBV1NfUkVHSU9OJyBpbiBlbnYgJiZcbiAgICB0eXBlb2YgZW52LkFXU19SRUdJT04gPT09ICdzdHJpbmcnICYmXG4gICAgJ0FNUExJRllfREFUQV9ERUZBVUxUX05BTUUnIGluIGVudiAmJlxuICAgIHR5cGVvZiBlbnYuQU1QTElGWV9EQVRBX0RFRkFVTFRfTkFNRSA9PT0gJ3N0cmluZydcbiAgKTtcbn07XG5cbi8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvbiAqL1xuZXhwb3J0IHR5cGUgUmVzb3VyY2VDb25maWcgPSB7XG4gIEFQSToge1xuICAgIEdyYXBoUUw6IHtcbiAgICAgIGVuZHBvaW50OiBzdHJpbmc7XG4gICAgICByZWdpb246IHN0cmluZztcbiAgICAgIGRlZmF1bHRBdXRoTW9kZTogJ2lhbSc7XG4gICAgICAvLyBVc2luZyBgYW55YCB0byBhdm9pZCByZXByb2R1Y2luZyAxMDArIGxpbmVzIG9mIHR5cGluZyB0byBtYXRjaCB0aGUgZXhwZWN0ZWQgc2hhcGUgZGVmaW5lZCBpbiBhd3MtYW1wbGlmeTpcbiAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hd3MtYW1wbGlmeS9hbXBsaWZ5LWpzL2Jsb2IvbWFpbi9wYWNrYWdlcy9jb3JlL3NyYy9zaW5nbGV0b24vQVBJL3R5cGVzLnRzI0wxNDMtTDE1M1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgICAgIG1vZGVsSW50cm9zcGVjdGlvbjogYW55O1xuICAgIH07XG4gIH07XG59O1xuLyogZXNsaW50LWVuYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbmFtaW5nLWNvbnZlbnRpb24gKi9cblxuY29uc3QgZ2V0UmVzb3VyY2VDb25maWcgPSAoXG4gIGVudjogRXh0ZW5kZWRBbXBsaWZ5Q2xpZW50RW52LFxuICBtb2RlbEludHJvc3BlY3Rpb25TY2hlbWE6IG9iamVjdFxuKTogUmVzb3VyY2VDb25maWcgPT4ge1xuICByZXR1cm4ge1xuICAgIEFQSToge1xuICAgICAgR3JhcGhRTDoge1xuICAgICAgICBlbmRwb2ludDogZW52LmRhdGFFbmRwb2ludCxcbiAgICAgICAgcmVnaW9uOiBlbnYuQVdTX1JFR0lPTixcbiAgICAgICAgZGVmYXVsdEF1dGhNb2RlOiAnaWFtJyBhcyBjb25zdCxcbiAgICAgICAgbW9kZWxJbnRyb3NwZWN0aW9uOiBtb2RlbEludHJvc3BlY3Rpb25TY2hlbWEsXG4gICAgICB9LFxuICAgIH0sXG4gIH07XG59O1xuXG5leHBvcnQgdHlwZSBMaWJyYXJ5T3B0aW9ucyA9IHtcbiAgLyogZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvbiAqL1xuICBBdXRoOiB7XG4gICAgY3JlZGVudGlhbHNQcm92aWRlcjoge1xuICAgICAgZ2V0Q3JlZGVudGlhbHNBbmRJZGVudGl0eUlkOiAoKSA9PiBQcm9taXNlPHtcbiAgICAgICAgY3JlZGVudGlhbHM6IHtcbiAgICAgICAgICBhY2Nlc3NLZXlJZDogc3RyaW5nO1xuICAgICAgICAgIHNlY3JldEFjY2Vzc0tleTogc3RyaW5nO1xuICAgICAgICAgIHNlc3Npb25Ub2tlbjogc3RyaW5nO1xuICAgICAgICB9O1xuICAgICAgfT47XG4gICAgICBjbGVhckNyZWRlbnRpYWxzQW5kSWRlbnRpdHlJZDogKCkgPT4gdm9pZDtcbiAgICB9O1xuICB9O1xufTtcblxuY29uc3QgZ2V0TGlicmFyeU9wdGlvbnMgPSAoZW52OiBEYXRhQ2xpZW50RW52KTogTGlicmFyeU9wdGlvbnMgPT4ge1xuICByZXR1cm4ge1xuICAgIEF1dGg6IHtcbiAgICAgIGNyZWRlbnRpYWxzUHJvdmlkZXI6IHtcbiAgICAgICAgZ2V0Q3JlZGVudGlhbHNBbmRJZGVudGl0eUlkOiBhc3luYyAoKSA9PiAoe1xuICAgICAgICAgIGNyZWRlbnRpYWxzOiB7XG4gICAgICAgICAgICBhY2Nlc3NLZXlJZDogZW52LkFXU19BQ0NFU1NfS0VZX0lELFxuICAgICAgICAgICAgc2VjcmV0QWNjZXNzS2V5OiBlbnYuQVdTX1NFQ1JFVF9BQ0NFU1NfS0VZLFxuICAgICAgICAgICAgc2Vzc2lvblRva2VuOiBlbnYuQVdTX1NFU1NJT05fVE9LRU4sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSksXG4gICAgICAgIGNsZWFyQ3JlZGVudGlhbHNBbmRJZGVudGl0eUlkOiAoKSA9PiB7XG4gICAgICAgICAgLyogbm9vcCAqL1xuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9LFxuICB9O1xufTtcblxuZXhwb3J0IHR5cGUgSW52YWxpZENvbmZpZyA9IHVua25vd24gJiB7XG4gIGludmFsaWRUeXBlOiAnU29tZSBvZiB0aGUgQVdTIGVudmlyb25tZW50IHZhcmlhYmxlcyBuZWVkZWQgdG8gY29uZmlndXJlIEFtcGxpZnkgYXJlIG1pc3NpbmcuJztcbn07XG5cbmV4cG9ydCB0eXBlIERhdGFDbGllbnRFcnJvciA9IHtcbiAgcmVzb3VyY2VDb25maWc6IEludmFsaWRDb25maWc7XG4gIGxpYnJhcnlPcHRpb25zOiBJbnZhbGlkQ29uZmlnO1xufTtcblxuZXhwb3J0IHR5cGUgRGF0YUNsaWVudENvbmZpZyA9IHtcbiAgcmVzb3VyY2VDb25maWc6IFJlc291cmNlQ29uZmlnO1xuICBsaWJyYXJ5T3B0aW9uczogTGlicmFyeU9wdGlvbnM7XG59O1xuXG5leHBvcnQgdHlwZSBEYXRhQ2xpZW50UmV0dXJuPFQ+ID0gVCBleHRlbmRzIERhdGFDbGllbnRFbnZcbiAgPyBEYXRhQ2xpZW50Q29uZmlnXG4gIDogRGF0YUNsaWVudEVycm9yO1xuXG5jb25zdCBleHRlbmRFbnYgPSAoXG4gIGVudjogRGF0YUNsaWVudEVudiAmIFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxuICBkYXRhTmFtZTogc3RyaW5nXG4pOiBFeHRlbmRlZEFtcGxpZnlDbGllbnRFbnYgPT4ge1xuICBjb25zdCBidWNrZXROYW1lID0gYCR7ZGF0YU5hbWV9JHtkYXRhQnVja2V0TmFtZUNvbnRlbnR9YDtcbiAgY29uc3Qga2V5TmFtZSA9IGAke2RhdGFOYW1lfSR7ZGF0YUtleU5hbWVDb250ZW50fWA7XG4gIGNvbnN0IGVuZHBvaW50TmFtZSA9IGAke2RhdGFOYW1lfSR7ZGF0YUVuZHBvaW50TmFtZUNvbnRlbnR9YDtcbiAgaWYgKFxuICAgICEoXG4gICAgICBidWNrZXROYW1lIGluIGVudiAmJlxuICAgICAga2V5TmFtZSBpbiBlbnYgJiZcbiAgICAgIGVuZHBvaW50TmFtZSBpbiBlbnYgJiZcbiAgICAgIHR5cGVvZiBlbnZbYnVja2V0TmFtZV0gPT09ICdzdHJpbmcnICYmXG4gICAgICB0eXBlb2YgZW52W2tleU5hbWVdID09PSAnc3RyaW5nJyAmJlxuICAgICAgdHlwZW9mIGVudltlbmRwb2ludE5hbWVdID09PSAnc3RyaW5nJ1xuICAgIClcbiAgKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYFRoZSBkYXRhIGVudmlyb25tZW50IHZhcmlhYmxlcyBhcmUgbWFsZm9ybWVkLiBlbnY9JHtKU09OLnN0cmluZ2lmeShlbnYpfWBcbiAgICApO1xuICB9XG5cbiAgY29uc3QgZGF0YUJ1Y2tldCA9IGVudltidWNrZXROYW1lXSBhcyBzdHJpbmc7XG4gIGNvbnN0IGRhdGFLZXkgPSBlbnZba2V5TmFtZV0gYXMgc3RyaW5nO1xuICBjb25zdCBkYXRhRW5kcG9pbnQgPSBlbnZbZW5kcG9pbnROYW1lXSBhcyBzdHJpbmc7XG5cbiAgcmV0dXJuIHtcbiAgICAuLi5lbnYsXG4gICAgZGF0YUJ1Y2tldCxcbiAgICBkYXRhS2V5LFxuICAgIGRhdGFFbmRwb2ludCxcbiAgfTtcbn07XG5cbi8qKlxuICogR2VuZXJhdGUgdGhlIGByZXNvdXJjZUNvbmZpZ2AgYW5kIGBsaWJyYXJ5T3B0aW9uc2AgbmVlZCB0byBjb25maWd1cmVcbiAqIEFtcGxpZnkgZm9yIHRoZSBkYXRhIGNsaWVudCBpbiBhIGxhbWJkYS5cbiAqXG4gKiBZb3VyIGZ1bmN0aW9uIG5lZWRzIHRvIGJlIGdyYW50ZWQgcmVzb3VyY2UgYWNjZXNzIG9uIHlvdXIgc2NoZW1hIGZvciB0aGlzIHRvIHdvcmtcbiAqIGBhLnNjaGVtYSguLi4pLmF1dGhvcml6YXRpb24oKGFsbG93KSA9PiBbYS5yZXNvdXJjZShteUZ1bmN0aW9uKV0pYFxuICogQHBhcmFtIGVudiAtIFRoZSBlbnZpcm9ubWVudCB2YXJpYWJsZXMgZm9yIHRoZSBkYXRhIGNsaWVudFxuICogQHJldHVybnMgQW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGByZXNvdXJjZUNvbmZpZ2AgYW5kIGBsaWJyYXJ5T3B0aW9uc2BcbiAqL1xuZXhwb3J0IGNvbnN0IGdldEFtcGxpZnlEYXRhQ2xpZW50Q29uZmlnID0gYXN5bmMgPFQ+KFxuICBlbnY6IFQsXG4gIHMzQ2xpZW50PzogUzNDbGllbnRcbik6IFByb21pc2U8RGF0YUNsaWVudFJldHVybjxUPj4gPT4ge1xuICBpZiAoIXMzQ2xpZW50KSB7XG4gICAgczNDbGllbnQgPSBuZXcgUzNDbGllbnQoKTtcbiAgfVxuICBpZiAoZW52ID09PSBudWxsIHx8IHR5cGVvZiBlbnYgIT09ICdvYmplY3QnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGVudmlyb25tZW50IHZhcmlhYmxlczogJHtKU09OLnN0cmluZ2lmeShlbnYpfWApO1xuICB9XG5cbiAgaWYgKCFpc0FtcGxpZnlDbGllbnRFbnYoZW52KSkge1xuICAgIHJldHVybiB7IHJlc291cmNlQ29uZmlnOiB7fSwgbGlicmFyeU9wdGlvbnM6IHt9IH0gYXMgRGF0YUNsaWVudFJldHVybjxUPjtcbiAgfVxuXG4gIGNvbnN0IGRhdGFOYW1lID0gbmV3IE5hbWluZ0NvbnZlcnRlcigpLnRvU2NyZWFtaW5nU25ha2VDYXNlKFxuICAgIGVudi5BTVBMSUZZX0RBVEFfREVGQVVMVF9OQU1FXG4gICk7XG4gIGNvbnN0IGV4dGVuZGVkRW52ID0gZXh0ZW5kRW52KGVudiwgZGF0YU5hbWUpO1xuXG4gIGxldCBtb2RlbEludHJvc3BlY3Rpb25TY2hlbWE6IG9iamVjdDtcblxuICB0cnkge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgczNDbGllbnQuc2VuZChcbiAgICAgIG5ldyBHZXRPYmplY3RDb21tYW5kKHtcbiAgICAgICAgQnVja2V0OiBleHRlbmRlZEVudi5kYXRhQnVja2V0LFxuICAgICAgICBLZXk6IGV4dGVuZGVkRW52LmRhdGFLZXksXG4gICAgICB9KVxuICAgICk7XG4gICAgY29uc3QgbW9kZWxJbnRyb3NwZWN0aW9uU2NoZW1hSnNvbiA9XG4gICAgICBhd2FpdCByZXNwb25zZS5Cb2R5Py50cmFuc2Zvcm1Ub1N0cmluZygpO1xuICAgIG1vZGVsSW50cm9zcGVjdGlvblNjaGVtYSA9IEpTT04ucGFyc2UobW9kZWxJbnRyb3NwZWN0aW9uU2NoZW1hSnNvbiA/PyAne30nKTtcbiAgfSBjYXRjaCAoY2F1Z2h0KSB7XG4gICAgaWYgKGNhdWdodCBpbnN0YW5jZW9mIE5vU3VjaEtleSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnRXJyb3IgcmV0cmlldmluZyB0aGUgc2NoZW1hIGZyb20gUzMuIFBsZWFzZSBjb25maXJtIHRoYXQgeW91ciBwcm9qZWN0IGhhcyBhIGBkZWZpbmVEYXRhYCBpbmNsdWRlZCBpbiB0aGUgYGRlZmluZUJhY2tlbmRgIGRlZmluaXRpb24uJ1xuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKGNhdWdodCBpbnN0YW5jZW9mIFMzU2VydmljZUV4Y2VwdGlvbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRXJyb3IgcmV0cmlldmluZyB0aGUgc2NoZW1hIGZyb20gUzMuIFlvdSBtYXkgbmVlZCB0byBncmFudCB0aGlzIGZ1bmN0aW9uIGF1dGhvcml6YXRpb24gb24gdGhlIHNjaGVtYS4gJHtjYXVnaHQubmFtZX06ICR7Y2F1Z2h0Lm1lc3NhZ2V9LmBcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IGNhdWdodDtcbiAgICB9XG4gIH1cblxuICBjb25zdCBsaWJyYXJ5T3B0aW9ucyA9IGdldExpYnJhcnlPcHRpb25zKGVudik7XG5cbiAgY29uc3QgcmVzb3VyY2VDb25maWcgPSBnZXRSZXNvdXJjZUNvbmZpZyhcbiAgICBleHRlbmRlZEVudixcbiAgICBtb2RlbEludHJvc3BlY3Rpb25TY2hlbWFcbiAgKTtcblxuICByZXR1cm4geyByZXNvdXJjZUNvbmZpZywgbGlicmFyeU9wdGlvbnMgfSBhcyBEYXRhQ2xpZW50UmV0dXJuPFQ+O1xufTtcbiJdfQ==