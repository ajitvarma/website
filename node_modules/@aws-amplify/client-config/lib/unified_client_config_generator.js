import { unifiedBackendOutputSchema } from '@aws-amplify/backend-output-schemas';
import { AmplifyUserError, ObjectAccumulator, ObjectAccumulatorPropertyAlreadyExistsError, ObjectAccumulatorVersionMismatchError, } from '@aws-amplify/platform-core';
import { BackendOutputClientError, BackendOutputClientErrorType, } from '@aws-amplify/deployed-backend-client';
/**
 * Right now this is mostly a stub. This will become a translation layer between backend output and frontend config
 *
 * There may be multiple implementations of this for different frontends
 */
export class UnifiedClientConfigGenerator {
    fetchOutput;
    clientConfigContributors;
    /**
     * Provide a reference to how this config generator should retrieve backend output
     */
    constructor(fetchOutput, clientConfigContributors) {
        this.fetchOutput = fetchOutput;
        this.clientConfigContributors = clientConfigContributors;
    }
    /**
     * Fetch all backend output, invoke each ClientConfigContributor on the result and merge into a single config object
     */
    generateClientConfig = async () => {
        let output;
        try {
            output = await this.fetchOutput();
        }
        catch (error) {
            if (BackendOutputClientError.isBackendOutputClientError(error) &&
                error.code === BackendOutputClientErrorType.DEPLOYMENT_IN_PROGRESS) {
                throw new AmplifyUserError('DeploymentInProgressError', {
                    message: 'Deployment is currently in progress.',
                    resolution: 'Re-run this command once the deployment completes.',
                }, error);
            }
            if (BackendOutputClientError.isBackendOutputClientError(error) &&
                error.code === BackendOutputClientErrorType.NO_STACK_FOUND) {
                throw new AmplifyUserError('StackDoesNotExistError', {
                    message: 'Stack does not exist.',
                    resolution: 'Ensure the CloudFormation stack ID or Amplify App ID and branch specified are correct and exists, then re-run this command.',
                }, error);
            }
            if (BackendOutputClientError.isBackendOutputClientError(error) &&
                error.code === BackendOutputClientErrorType.METADATA_RETRIEVAL_ERROR) {
                throw new AmplifyUserError('NonAmplifyStackError', {
                    message: 'Stack was not created with Amplify.',
                    resolution: 'Ensure the CloudFormation stack ID references a main stack created with Amplify, then re-run this command.',
                }, error);
            }
            if (BackendOutputClientError.isBackendOutputClientError(error) &&
                error.code === BackendOutputClientErrorType.CREDENTIALS_ERROR) {
                throw new AmplifyUserError('CredentialsError', {
                    message: 'Unable to get backend outputs due to invalid credentials.',
                    resolution: 'Ensure your AWS credentials are correctly set and refreshed.',
                }, error);
            }
            if (BackendOutputClientError.isBackendOutputClientError(error) &&
                error.code === BackendOutputClientErrorType.ACCESS_DENIED) {
                throw new AmplifyUserError('AccessDeniedError', {
                    message: 'Unable to get backend outputs due to insufficient permissions.',
                    resolution: 'Ensure you have permissions to call cloudformation:GetTemplateSummary.',
                }, error);
            }
            throw error;
        }
        const backendOutput = unifiedBackendOutputSchema.parse(output);
        const accumulator = new ObjectAccumulator({});
        for (const contributor of this.clientConfigContributors) {
            const clientConfigContribution = await contributor.contribute(backendOutput);
            try {
                // Partial to DeepPartialAmplifyGeneratedConfigs is always a safe case since it's up-casting
                accumulator.accumulate(clientConfigContribution);
            }
            catch (error) {
                if (error instanceof ObjectAccumulatorPropertyAlreadyExistsError) {
                    throw new AmplifyUserError('OutputEntryAlreadyExistsError', {
                        message: `Duplicated entry with key ${error.key} detected in deployment outputs`,
                        resolution: "Check if 'backend.addOutput' is called multiple times with overlapping inputs or" +
                            " if 'backend.addOutput' is called with values overlapping Amplify managed keys",
                    }, error);
                }
                if (error instanceof ObjectAccumulatorVersionMismatchError) {
                    throw new AmplifyUserError('VersionMismatchError', {
                        message: `Conflicting versions of client configuration found. `,
                        resolution: "Ensure that the version specified in 'backend.addOutput' is consistent" +
                            ' and is same as the one used for generating the client config',
                    }, error);
                }
                throw error;
            }
        }
        return accumulator.getAccumulatedObject();
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidW5pZmllZF9jbGllbnRfY29uZmlnX2dlbmVyYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy91bmlmaWVkX2NsaWVudF9jb25maWdfZ2VuZXJhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUlBLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBSWpGLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsaUJBQWlCLEVBQ2pCLDJDQUEyQyxFQUMzQyxxQ0FBcUMsR0FDdEMsTUFBTSw0QkFBNEIsQ0FBQztBQUNwQyxPQUFPLEVBQ0wsd0JBQXdCLEVBQ3hCLDRCQUE0QixHQUM3QixNQUFNLHNDQUFzQyxDQUFDO0FBRTlDOzs7O0dBSUc7QUFDSCxNQUFNLE9BQU8sNEJBQTRCO0lBS3BCO0lBQ0E7SUFMbkI7O09BRUc7SUFDSCxZQUNtQixXQUF5QyxFQUN6Qyx3QkFBbUQ7UUFEbkQsZ0JBQVcsR0FBWCxXQUFXLENBQThCO1FBQ3pDLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMkI7SUFDbkUsQ0FBQztJQUVKOztPQUVHO0lBQ0gsb0JBQW9CLEdBQUcsS0FBSyxJQUEyQixFQUFFO1FBQ3ZELElBQUksTUFBTSxDQUFDO1FBQ1gsSUFBSTtZQUNGLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUNuQztRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ2QsSUFDRSx3QkFBd0IsQ0FBQywwQkFBMEIsQ0FBQyxLQUFLLENBQUM7Z0JBQzFELEtBQUssQ0FBQyxJQUFJLEtBQUssNEJBQTRCLENBQUMsc0JBQXNCLEVBQ2xFO2dCQUNBLE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsMkJBQTJCLEVBQzNCO29CQUNFLE9BQU8sRUFBRSxzQ0FBc0M7b0JBQy9DLFVBQVUsRUFBRSxvREFBb0Q7aUJBQ2pFLEVBQ0QsS0FBSyxDQUNOLENBQUM7YUFDSDtZQUNELElBQ0Usd0JBQXdCLENBQUMsMEJBQTBCLENBQUMsS0FBSyxDQUFDO2dCQUMxRCxLQUFLLENBQUMsSUFBSSxLQUFLLDRCQUE0QixDQUFDLGNBQWMsRUFDMUQ7Z0JBQ0EsTUFBTSxJQUFJLGdCQUFnQixDQUN4Qix3QkFBd0IsRUFDeEI7b0JBQ0UsT0FBTyxFQUFFLHVCQUF1QjtvQkFDaEMsVUFBVSxFQUNSLDZIQUE2SDtpQkFDaEksRUFDRCxLQUFLLENBQ04sQ0FBQzthQUNIO1lBQ0QsSUFDRSx3QkFBd0IsQ0FBQywwQkFBMEIsQ0FBQyxLQUFLLENBQUM7Z0JBQzFELEtBQUssQ0FBQyxJQUFJLEtBQUssNEJBQTRCLENBQUMsd0JBQXdCLEVBQ3BFO2dCQUNBLE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsc0JBQXNCLEVBQ3RCO29CQUNFLE9BQU8sRUFBRSxxQ0FBcUM7b0JBQzlDLFVBQVUsRUFDUiw0R0FBNEc7aUJBQy9HLEVBQ0QsS0FBSyxDQUNOLENBQUM7YUFDSDtZQUNELElBQ0Usd0JBQXdCLENBQUMsMEJBQTBCLENBQUMsS0FBSyxDQUFDO2dCQUMxRCxLQUFLLENBQUMsSUFBSSxLQUFLLDRCQUE0QixDQUFDLGlCQUFpQixFQUM3RDtnQkFDQSxNQUFNLElBQUksZ0JBQWdCLENBQ3hCLGtCQUFrQixFQUNsQjtvQkFDRSxPQUFPLEVBQ0wsMkRBQTJEO29CQUM3RCxVQUFVLEVBQ1IsOERBQThEO2lCQUNqRSxFQUNELEtBQUssQ0FDTixDQUFDO2FBQ0g7WUFDRCxJQUNFLHdCQUF3QixDQUFDLDBCQUEwQixDQUFDLEtBQUssQ0FBQztnQkFDMUQsS0FBSyxDQUFDLElBQUksS0FBSyw0QkFBNEIsQ0FBQyxhQUFhLEVBQ3pEO2dCQUNBLE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsbUJBQW1CLEVBQ25CO29CQUNFLE9BQU8sRUFDTCxnRUFBZ0U7b0JBQ2xFLFVBQVUsRUFDUix3RUFBd0U7aUJBQzNFLEVBQ0QsS0FBSyxDQUNOLENBQUM7YUFDSDtZQUVELE1BQU0sS0FBSyxDQUFDO1NBQ2I7UUFDRCxNQUFNLGFBQWEsR0FBRywwQkFBMEIsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFL0QsTUFBTSxXQUFXLEdBQUcsSUFBSSxpQkFBaUIsQ0FBZSxFQUFFLENBQUMsQ0FBQztRQUU1RCxLQUFLLE1BQU0sV0FBVyxJQUFJLElBQUksQ0FBQyx3QkFBd0IsRUFBRTtZQUN2RCxNQUFNLHdCQUF3QixHQUFHLE1BQU0sV0FBVyxDQUFDLFVBQVUsQ0FDM0QsYUFBYSxDQUNkLENBQUM7WUFDRixJQUFJO2dCQUNGLDRGQUE0RjtnQkFDNUYsV0FBVyxDQUFDLFVBQVUsQ0FDcEIsd0JBQTRFLENBQzdFLENBQUM7YUFDSDtZQUFDLE9BQU8sS0FBSyxFQUFFO2dCQUNkLElBQUksS0FBSyxZQUFZLDJDQUEyQyxFQUFFO29CQUNoRSxNQUFNLElBQUksZ0JBQWdCLENBQ3hCLCtCQUErQixFQUMvQjt3QkFDRSxPQUFPLEVBQUUsNkJBQTZCLEtBQUssQ0FBQyxHQUFHLGlDQUFpQzt3QkFDaEYsVUFBVSxFQUNSLGtGQUFrRjs0QkFDbEYsZ0ZBQWdGO3FCQUNuRixFQUNELEtBQUssQ0FDTixDQUFDO2lCQUNIO2dCQUNELElBQUksS0FBSyxZQUFZLHFDQUFxQyxFQUFFO29CQUMxRCxNQUFNLElBQUksZ0JBQWdCLENBQ3hCLHNCQUFzQixFQUN0Qjt3QkFDRSxPQUFPLEVBQUUsc0RBQXNEO3dCQUMvRCxVQUFVLEVBQ1Isd0VBQXdFOzRCQUN4RSwrREFBK0Q7cUJBQ2xFLEVBQ0QsS0FBSyxDQUNOLENBQUM7aUJBQ0g7Z0JBQ0QsTUFBTSxLQUFLLENBQUM7YUFDYjtTQUNGO1FBQ0QsT0FBcUIsV0FBVyxDQUFDLG9CQUFvQixFQUFFLENBQUM7SUFDMUQsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBCYWNrZW5kT3V0cHV0LFxuICBEZWVwUGFydGlhbEFtcGxpZnlHZW5lcmF0ZWRDb25maWdzLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IHVuaWZpZWRCYWNrZW5kT3V0cHV0U2NoZW1hIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0IHsgQ2xpZW50Q29uZmlnIH0gZnJvbSAnLi9jbGllbnQtY29uZmlnLXR5cGVzL2NsaWVudF9jb25maWcuanMnO1xuaW1wb3J0IHsgQ2xpZW50Q29uZmlnQ29udHJpYnV0b3IgfSBmcm9tICcuL2NsaWVudC1jb25maWctdHlwZXMvY2xpZW50X2NvbmZpZ19jb250cmlidXRvci5qcyc7XG5pbXBvcnQgeyBDbGllbnRDb25maWdHZW5lcmF0b3IgfSBmcm9tICcuL2NsaWVudF9jb25maWdfZ2VuZXJhdG9yLmpzJztcbmltcG9ydCB7XG4gIEFtcGxpZnlVc2VyRXJyb3IsXG4gIE9iamVjdEFjY3VtdWxhdG9yLFxuICBPYmplY3RBY2N1bXVsYXRvclByb3BlcnR5QWxyZWFkeUV4aXN0c0Vycm9yLFxuICBPYmplY3RBY2N1bXVsYXRvclZlcnNpb25NaXNtYXRjaEVycm9yLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQge1xuICBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IsXG4gIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9kZXBsb3llZC1iYWNrZW5kLWNsaWVudCc7XG5cbi8qKlxuICogUmlnaHQgbm93IHRoaXMgaXMgbW9zdGx5IGEgc3R1Yi4gVGhpcyB3aWxsIGJlY29tZSBhIHRyYW5zbGF0aW9uIGxheWVyIGJldHdlZW4gYmFja2VuZCBvdXRwdXQgYW5kIGZyb250ZW5kIGNvbmZpZ1xuICpcbiAqIFRoZXJlIG1heSBiZSBtdWx0aXBsZSBpbXBsZW1lbnRhdGlvbnMgb2YgdGhpcyBmb3IgZGlmZmVyZW50IGZyb250ZW5kc1xuICovXG5leHBvcnQgY2xhc3MgVW5pZmllZENsaWVudENvbmZpZ0dlbmVyYXRvciBpbXBsZW1lbnRzIENsaWVudENvbmZpZ0dlbmVyYXRvciB7XG4gIC8qKlxuICAgKiBQcm92aWRlIGEgcmVmZXJlbmNlIHRvIGhvdyB0aGlzIGNvbmZpZyBnZW5lcmF0b3Igc2hvdWxkIHJldHJpZXZlIGJhY2tlbmQgb3V0cHV0XG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGZldGNoT3V0cHV0OiAoKSA9PiBQcm9taXNlPEJhY2tlbmRPdXRwdXQ+LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY2xpZW50Q29uZmlnQ29udHJpYnV0b3JzOiBDbGllbnRDb25maWdDb250cmlidXRvcltdXG4gICkge31cblxuICAvKipcbiAgICogRmV0Y2ggYWxsIGJhY2tlbmQgb3V0cHV0LCBpbnZva2UgZWFjaCBDbGllbnRDb25maWdDb250cmlidXRvciBvbiB0aGUgcmVzdWx0IGFuZCBtZXJnZSBpbnRvIGEgc2luZ2xlIGNvbmZpZyBvYmplY3RcbiAgICovXG4gIGdlbmVyYXRlQ2xpZW50Q29uZmlnID0gYXN5bmMgKCk6IFByb21pc2U8Q2xpZW50Q29uZmlnPiA9PiB7XG4gICAgbGV0IG91dHB1dDtcbiAgICB0cnkge1xuICAgICAgb3V0cHV0ID0gYXdhaXQgdGhpcy5mZXRjaE91dHB1dCgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoXG4gICAgICAgIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvci5pc0JhY2tlbmRPdXRwdXRDbGllbnRFcnJvcihlcnJvcikgJiZcbiAgICAgICAgZXJyb3IuY29kZSA9PT0gQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5ERVBMT1lNRU5UX0lOX1BST0dSRVNTXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICAgJ0RlcGxveW1lbnRJblByb2dyZXNzRXJyb3InLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdEZXBsb3ltZW50IGlzIGN1cnJlbnRseSBpbiBwcm9ncmVzcy4nLFxuICAgICAgICAgICAgcmVzb2x1dGlvbjogJ1JlLXJ1biB0aGlzIGNvbW1hbmQgb25jZSB0aGUgZGVwbG95bWVudCBjb21wbGV0ZXMuJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGVycm9yXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoXG4gICAgICAgIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvci5pc0JhY2tlbmRPdXRwdXRDbGllbnRFcnJvcihlcnJvcikgJiZcbiAgICAgICAgZXJyb3IuY29kZSA9PT0gQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5OT19TVEFDS19GT1VORFxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAgICdTdGFja0RvZXNOb3RFeGlzdEVycm9yJyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBtZXNzYWdlOiAnU3RhY2sgZG9lcyBub3QgZXhpc3QuJyxcbiAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICdFbnN1cmUgdGhlIENsb3VkRm9ybWF0aW9uIHN0YWNrIElEIG9yIEFtcGxpZnkgQXBwIElEIGFuZCBicmFuY2ggc3BlY2lmaWVkIGFyZSBjb3JyZWN0IGFuZCBleGlzdHMsIHRoZW4gcmUtcnVuIHRoaXMgY29tbWFuZC4nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZXJyb3JcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChcbiAgICAgICAgQmFja2VuZE91dHB1dENsaWVudEVycm9yLmlzQmFja2VuZE91dHB1dENsaWVudEVycm9yKGVycm9yKSAmJlxuICAgICAgICBlcnJvci5jb2RlID09PSBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLk1FVEFEQVRBX1JFVFJJRVZBTF9FUlJPUlxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAgICdOb25BbXBsaWZ5U3RhY2tFcnJvcicsXG4gICAgICAgICAge1xuICAgICAgICAgICAgbWVzc2FnZTogJ1N0YWNrIHdhcyBub3QgY3JlYXRlZCB3aXRoIEFtcGxpZnkuJyxcbiAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICdFbnN1cmUgdGhlIENsb3VkRm9ybWF0aW9uIHN0YWNrIElEIHJlZmVyZW5jZXMgYSBtYWluIHN0YWNrIGNyZWF0ZWQgd2l0aCBBbXBsaWZ5LCB0aGVuIHJlLXJ1biB0aGlzIGNvbW1hbmQuJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGVycm9yXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoXG4gICAgICAgIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvci5pc0JhY2tlbmRPdXRwdXRDbGllbnRFcnJvcihlcnJvcikgJiZcbiAgICAgICAgZXJyb3IuY29kZSA9PT0gQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5DUkVERU5USUFMU19FUlJPUlxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAgICdDcmVkZW50aWFsc0Vycm9yJyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICAgICAnVW5hYmxlIHRvIGdldCBiYWNrZW5kIG91dHB1dHMgZHVlIHRvIGludmFsaWQgY3JlZGVudGlhbHMuJyxcbiAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICdFbnN1cmUgeW91ciBBV1MgY3JlZGVudGlhbHMgYXJlIGNvcnJlY3RseSBzZXQgYW5kIHJlZnJlc2hlZC4nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZXJyb3JcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChcbiAgICAgICAgQmFja2VuZE91dHB1dENsaWVudEVycm9yLmlzQmFja2VuZE91dHB1dENsaWVudEVycm9yKGVycm9yKSAmJlxuICAgICAgICBlcnJvci5jb2RlID09PSBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLkFDQ0VTU19ERU5JRURcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgICAnQWNjZXNzRGVuaWVkRXJyb3InLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgICAgICdVbmFibGUgdG8gZ2V0IGJhY2tlbmQgb3V0cHV0cyBkdWUgdG8gaW5zdWZmaWNpZW50IHBlcm1pc3Npb25zLicsXG4gICAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgICAnRW5zdXJlIHlvdSBoYXZlIHBlcm1pc3Npb25zIHRvIGNhbGwgY2xvdWRmb3JtYXRpb246R2V0VGVtcGxhdGVTdW1tYXJ5LicsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBlcnJvclxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gICAgY29uc3QgYmFja2VuZE91dHB1dCA9IHVuaWZpZWRCYWNrZW5kT3V0cHV0U2NoZW1hLnBhcnNlKG91dHB1dCk7XG5cbiAgICBjb25zdCBhY2N1bXVsYXRvciA9IG5ldyBPYmplY3RBY2N1bXVsYXRvcjxDbGllbnRDb25maWc+KHt9KTtcblxuICAgIGZvciAoY29uc3QgY29udHJpYnV0b3Igb2YgdGhpcy5jbGllbnRDb25maWdDb250cmlidXRvcnMpIHtcbiAgICAgIGNvbnN0IGNsaWVudENvbmZpZ0NvbnRyaWJ1dGlvbiA9IGF3YWl0IGNvbnRyaWJ1dG9yLmNvbnRyaWJ1dGUoXG4gICAgICAgIGJhY2tlbmRPdXRwdXRcbiAgICAgICk7XG4gICAgICB0cnkge1xuICAgICAgICAvLyBQYXJ0aWFsIHRvIERlZXBQYXJ0aWFsQW1wbGlmeUdlbmVyYXRlZENvbmZpZ3MgaXMgYWx3YXlzIGEgc2FmZSBjYXNlIHNpbmNlIGl0J3MgdXAtY2FzdGluZ1xuICAgICAgICBhY2N1bXVsYXRvci5hY2N1bXVsYXRlKFxuICAgICAgICAgIGNsaWVudENvbmZpZ0NvbnRyaWJ1dGlvbiBhcyBEZWVwUGFydGlhbEFtcGxpZnlHZW5lcmF0ZWRDb25maWdzPENsaWVudENvbmZpZz5cbiAgICAgICAgKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIE9iamVjdEFjY3VtdWxhdG9yUHJvcGVydHlBbHJlYWR5RXhpc3RzRXJyb3IpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgICAgICdPdXRwdXRFbnRyeUFscmVhZHlFeGlzdHNFcnJvcicsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIG1lc3NhZ2U6IGBEdXBsaWNhdGVkIGVudHJ5IHdpdGgga2V5ICR7ZXJyb3Iua2V5fSBkZXRlY3RlZCBpbiBkZXBsb3ltZW50IG91dHB1dHNgLFxuICAgICAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgICAgIFwiQ2hlY2sgaWYgJ2JhY2tlbmQuYWRkT3V0cHV0JyBpcyBjYWxsZWQgbXVsdGlwbGUgdGltZXMgd2l0aCBvdmVybGFwcGluZyBpbnB1dHMgb3JcIiArXG4gICAgICAgICAgICAgICAgXCIgaWYgJ2JhY2tlbmQuYWRkT3V0cHV0JyBpcyBjYWxsZWQgd2l0aCB2YWx1ZXMgb3ZlcmxhcHBpbmcgQW1wbGlmeSBtYW5hZ2VkIGtleXNcIixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlcnJvclxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgT2JqZWN0QWNjdW11bGF0b3JWZXJzaW9uTWlzbWF0Y2hFcnJvcikge1xuICAgICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAgICAgJ1ZlcnNpb25NaXNtYXRjaEVycm9yJyxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgbWVzc2FnZTogYENvbmZsaWN0aW5nIHZlcnNpb25zIG9mIGNsaWVudCBjb25maWd1cmF0aW9uIGZvdW5kLiBgLFxuICAgICAgICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICAgICAgIFwiRW5zdXJlIHRoYXQgdGhlIHZlcnNpb24gc3BlY2lmaWVkIGluICdiYWNrZW5kLmFkZE91dHB1dCcgaXMgY29uc2lzdGVudFwiICtcbiAgICAgICAgICAgICAgICAnIGFuZCBpcyBzYW1lIGFzIHRoZSBvbmUgdXNlZCBmb3IgZ2VuZXJhdGluZyB0aGUgY2xpZW50IGNvbmZpZycsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZXJyb3JcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gPENsaWVudENvbmZpZz5hY2N1bXVsYXRvci5nZXRBY2N1bXVsYXRlZE9iamVjdCgpO1xuICB9O1xufVxuIl19