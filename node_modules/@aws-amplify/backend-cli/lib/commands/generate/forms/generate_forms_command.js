import path from 'path';
import { BackendOutputClientError, BackendOutputClientErrorType, } from '@aws-amplify/deployed-backend-client';
import { graphqlOutputKey } from '@aws-amplify/backend-output-schemas';
import { DEFAULT_UI_PATH } from '../../../form-generation/default_form_generation_output_paths.js';
import { AmplifyUserError } from '@aws-amplify/platform-core';
/**
 * Command that generates UI forms.
 */
export class GenerateFormsCommand {
    backendIdentifierResolver;
    backendOutputClientBuilder;
    formGenerationHandler;
    /**
     * @inheritDoc
     */
    command;
    /**
     * @inheritDoc
     */
    describe;
    /**
     * Creates UI forms generation command.
     */
    constructor(backendIdentifierResolver, backendOutputClientBuilder, formGenerationHandler) {
        this.backendIdentifierResolver = backendIdentifierResolver;
        this.backendOutputClientBuilder = backendOutputClientBuilder;
        this.formGenerationHandler = formGenerationHandler;
        this.command = 'forms';
        this.describe = 'Generates UI forms';
    }
    getBackendIdentifier = async (args) => {
        return await this.backendIdentifierResolver.resolveDeployedBackendIdentifier(args);
    };
    /**
     * @inheritDoc
     */
    handler = async (args) => {
        const backendIdentifier = await this.backendIdentifierResolver.resolveDeployedBackendIdentifier(args);
        if (!backendIdentifier) {
            throw new AmplifyUserError('BackendIdentifierResolverError', {
                message: 'Could not resolve the backend identifier.',
                resolution: 'Ensure stack name or Amplify App ID and branch specified are correct and exists, then re-run this command.',
            });
        }
        const backendOutputClient = this.backendOutputClientBuilder();
        let output;
        try {
            output = await backendOutputClient.getOutput(backendIdentifier);
        }
        catch (error) {
            if (BackendOutputClientError.isBackendOutputClientError(error) &&
                error.code === BackendOutputClientErrorType.DEPLOYMENT_IN_PROGRESS) {
                throw new AmplifyUserError('DeploymentInProgressError', {
                    message: 'Deployment is currently in progress.',
                    resolution: 'Re-run this command once the deployment completes.',
                }, error);
            }
            if (BackendOutputClientError.isBackendOutputClientError(error) &&
                error.code === BackendOutputClientErrorType.NO_STACK_FOUND) {
                throw new AmplifyUserError('StackDoesNotExistError', {
                    message: 'Stack does not exist.',
                    resolution: 'Ensure the CloudFormation stack ID or Amplify App ID and branch specified are correct and exists, then re-run this command.',
                }, error);
            }
            if (BackendOutputClientError.isBackendOutputClientError(error) &&
                error.code === BackendOutputClientErrorType.CREDENTIALS_ERROR) {
                throw new AmplifyUserError('CredentialsError', {
                    message: 'Unable to get backend outputs due to invalid credentials.',
                    resolution: 'Ensure your AWS credentials are correctly set and refreshed.',
                }, error);
            }
            if (BackendOutputClientError.isBackendOutputClientError(error) &&
                error.code === BackendOutputClientErrorType.ACCESS_DENIED) {
                throw new AmplifyUserError('AccessDeniedError', {
                    message: 'Unable to get backend outputs due to insufficient permissions.',
                    resolution: 'Ensure you have permissions to call cloudformation:GetTemplateSummary.',
                }, error);
            }
            throw error;
        }
        if (!(graphqlOutputKey in output) || !output[graphqlOutputKey]) {
            throw new Error('No GraphQL API configured for this backend.');
        }
        const apiUrl = output[graphqlOutputKey].payload.amplifyApiModelSchemaS3Uri;
        if (!args.outDir) {
            throw new Error('out-dir must be defined');
        }
        const outDir = args.outDir;
        await this.formGenerationHandler.generate({
            modelsOutDir: path.join(outDir, 'graphql'),
            backendIdentifier,
            uiOutDir: outDir,
            apiUrl,
            modelsFilter: args.models,
        });
    };
    /**
     * @inheritDoc
     */
    builder = (yargs) => {
        return yargs
            .option('stack', {
            conflicts: ['app-id', 'branch'],
            describe: 'A stack name that contains an Amplify backend',
            type: 'string',
            array: false,
            group: 'Stack identifier',
        })
            .option('app-id', {
            conflicts: ['stack'],
            describe: 'The Amplify App ID of the project',
            type: 'string',
            array: false,
            implies: 'branch',
            group: 'Project identifier',
        })
            .option('branch', {
            conflicts: ['stack'],
            describe: 'A git branch of the Amplify project',
            type: 'string',
            array: false,
            group: 'Project identifier',
            implies: 'appId',
        })
            .option('out-dir', {
            describe: 'A path to directory where generated forms are written.',
            default: DEFAULT_UI_PATH,
            type: 'string',
            array: false,
            group: 'Form Generation',
        })
            .option('models', {
            describe: 'Model name to generate',
            type: 'string',
            array: true,
            group: 'Form Generation',
        });
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGVfZm9ybXNfY29tbWFuZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21tYW5kcy9nZW5lcmF0ZS9mb3Jtcy9nZW5lcmF0ZV9mb3Jtc19jb21tYW5kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUV4QixPQUFPLEVBRUwsd0JBQXdCLEVBQ3hCLDRCQUE0QixHQUM3QixNQUFNLHNDQUFzQyxDQUFDO0FBQzlDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBRXZFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxrRUFBa0UsQ0FBQztBQUduRyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQWE5RDs7R0FFRztBQUNILE1BQU0sT0FBTyxvQkFBb0I7SUFpQlo7SUFDQTtJQUNBO0lBaEJuQjs7T0FFRztJQUNNLE9BQU8sQ0FBUztJQUV6Qjs7T0FFRztJQUNNLFFBQVEsQ0FBUztJQUUxQjs7T0FFRztJQUNILFlBQ21CLHlCQUFvRCxFQUNwRCwwQkFBcUQsRUFDckQscUJBQTRDO1FBRjVDLDhCQUF5QixHQUF6Qix5QkFBeUIsQ0FBMkI7UUFDcEQsK0JBQTBCLEdBQTFCLDBCQUEwQixDQUEyQjtRQUNyRCwwQkFBcUIsR0FBckIscUJBQXFCLENBQXVCO1FBRTdELElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxRQUFRLEdBQUcsb0JBQW9CLENBQUM7SUFDdkMsQ0FBQztJQUVELG9CQUFvQixHQUFHLEtBQUssRUFBRSxJQUFpQyxFQUFFLEVBQUU7UUFDakUsT0FBTyxNQUFNLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxnQ0FBZ0MsQ0FDMUUsSUFBSSxDQUNMLENBQUM7SUFDSixDQUFDLENBQUM7SUFFRjs7T0FFRztJQUNILE9BQU8sR0FBRyxLQUFLLEVBQ2IsSUFBcUQsRUFDdEMsRUFBRTtRQUNqQixNQUFNLGlCQUFpQixHQUNyQixNQUFNLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxnQ0FBZ0MsQ0FDbkUsSUFBSSxDQUNMLENBQUM7UUFFSixJQUFJLENBQUMsaUJBQWlCLEVBQUU7WUFDdEIsTUFBTSxJQUFJLGdCQUFnQixDQUFDLGdDQUFnQyxFQUFFO2dCQUMzRCxPQUFPLEVBQUUsMkNBQTJDO2dCQUNwRCxVQUFVLEVBQ1IsNEdBQTRHO2FBQy9HLENBQUMsQ0FBQztTQUNKO1FBRUQsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLENBQUMsMEJBQTBCLEVBQUUsQ0FBQztRQUU5RCxJQUFJLE1BQU0sQ0FBQztRQUNYLElBQUk7WUFDRixNQUFNLEdBQUcsTUFBTSxtQkFBbUIsQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQUMsQ0FBQztTQUNqRTtRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ2QsSUFDRSx3QkFBd0IsQ0FBQywwQkFBMEIsQ0FBQyxLQUFLLENBQUM7Z0JBQzFELEtBQUssQ0FBQyxJQUFJLEtBQUssNEJBQTRCLENBQUMsc0JBQXNCLEVBQ2xFO2dCQUNBLE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsMkJBQTJCLEVBQzNCO29CQUNFLE9BQU8sRUFBRSxzQ0FBc0M7b0JBQy9DLFVBQVUsRUFBRSxvREFBb0Q7aUJBQ2pFLEVBQ0QsS0FBSyxDQUNOLENBQUM7YUFDSDtZQUNELElBQ0Usd0JBQXdCLENBQUMsMEJBQTBCLENBQUMsS0FBSyxDQUFDO2dCQUMxRCxLQUFLLENBQUMsSUFBSSxLQUFLLDRCQUE0QixDQUFDLGNBQWMsRUFDMUQ7Z0JBQ0EsTUFBTSxJQUFJLGdCQUFnQixDQUN4Qix3QkFBd0IsRUFDeEI7b0JBQ0UsT0FBTyxFQUFFLHVCQUF1QjtvQkFDaEMsVUFBVSxFQUNSLDZIQUE2SDtpQkFDaEksRUFDRCxLQUFLLENBQ04sQ0FBQzthQUNIO1lBQ0QsSUFDRSx3QkFBd0IsQ0FBQywwQkFBMEIsQ0FBQyxLQUFLLENBQUM7Z0JBQzFELEtBQUssQ0FBQyxJQUFJLEtBQUssNEJBQTRCLENBQUMsaUJBQWlCLEVBQzdEO2dCQUNBLE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsa0JBQWtCLEVBQ2xCO29CQUNFLE9BQU8sRUFDTCwyREFBMkQ7b0JBQzdELFVBQVUsRUFDUiw4REFBOEQ7aUJBQ2pFLEVBQ0QsS0FBSyxDQUNOLENBQUM7YUFDSDtZQUNELElBQ0Usd0JBQXdCLENBQUMsMEJBQTBCLENBQUMsS0FBSyxDQUFDO2dCQUMxRCxLQUFLLENBQUMsSUFBSSxLQUFLLDRCQUE0QixDQUFDLGFBQWEsRUFDekQ7Z0JBQ0EsTUFBTSxJQUFJLGdCQUFnQixDQUN4QixtQkFBbUIsRUFDbkI7b0JBQ0UsT0FBTyxFQUNMLGdFQUFnRTtvQkFDbEUsVUFBVSxFQUNSLHdFQUF3RTtpQkFDM0UsRUFDRCxLQUFLLENBQ04sQ0FBQzthQUNIO1lBRUQsTUFBTSxLQUFLLENBQUM7U0FDYjtRQUVELElBQUksQ0FBQyxDQUFDLGdCQUFnQixJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLEVBQUU7WUFDOUQsTUFBTSxJQUFJLEtBQUssQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO1NBQ2hFO1FBRUQsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUMsT0FBTyxDQUFDLDBCQUEwQixDQUFDO1FBRTNFLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ2hCLE1BQU0sSUFBSSxLQUFLLENBQUMseUJBQXlCLENBQUMsQ0FBQztTQUM1QztRQUVELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFFM0IsTUFBTSxJQUFJLENBQUMscUJBQXFCLENBQUMsUUFBUSxDQUFDO1lBQ3hDLFlBQVksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUM7WUFDMUMsaUJBQWlCO1lBQ2pCLFFBQVEsRUFBRSxNQUFNO1lBQ2hCLE1BQU07WUFDTixZQUFZLEVBQUUsSUFBSSxDQUFDLE1BQU07U0FDMUIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDO0lBRUY7O09BRUc7SUFDSCxPQUFPLEdBQUcsQ0FBQyxLQUFXLEVBQXFDLEVBQUU7UUFDM0QsT0FBTyxLQUFLO2FBQ1QsTUFBTSxDQUFDLE9BQU8sRUFBRTtZQUNmLFNBQVMsRUFBRSxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUM7WUFDL0IsUUFBUSxFQUFFLCtDQUErQztZQUN6RCxJQUFJLEVBQUUsUUFBUTtZQUNkLEtBQUssRUFBRSxLQUFLO1lBQ1osS0FBSyxFQUFFLGtCQUFrQjtTQUMxQixDQUFDO2FBQ0QsTUFBTSxDQUFDLFFBQVEsRUFBRTtZQUNoQixTQUFTLEVBQUUsQ0FBQyxPQUFPLENBQUM7WUFDcEIsUUFBUSxFQUFFLG1DQUFtQztZQUM3QyxJQUFJLEVBQUUsUUFBUTtZQUNkLEtBQUssRUFBRSxLQUFLO1lBQ1osT0FBTyxFQUFFLFFBQVE7WUFDakIsS0FBSyxFQUFFLG9CQUFvQjtTQUM1QixDQUFDO2FBQ0QsTUFBTSxDQUFDLFFBQVEsRUFBRTtZQUNoQixTQUFTLEVBQUUsQ0FBQyxPQUFPLENBQUM7WUFDcEIsUUFBUSxFQUFFLHFDQUFxQztZQUMvQyxJQUFJLEVBQUUsUUFBUTtZQUNkLEtBQUssRUFBRSxLQUFLO1lBQ1osS0FBSyxFQUFFLG9CQUFvQjtZQUMzQixPQUFPLEVBQUUsT0FBTztTQUNqQixDQUFDO2FBQ0QsTUFBTSxDQUFDLFNBQVMsRUFBRTtZQUNqQixRQUFRLEVBQUUsd0RBQXdEO1lBQ2xFLE9BQU8sRUFBRSxlQUFlO1lBQ3hCLElBQUksRUFBRSxRQUFRO1lBQ2QsS0FBSyxFQUFFLEtBQUs7WUFDWixLQUFLLEVBQUUsaUJBQWlCO1NBQ3pCLENBQUM7YUFDRCxNQUFNLENBQUMsUUFBUSxFQUFFO1lBQ2hCLFFBQVEsRUFBRSx3QkFBd0I7WUFDbEMsSUFBSSxFQUFFLFFBQVE7WUFDZCxLQUFLLEVBQUUsSUFBSTtZQUNYLEtBQUssRUFBRSxpQkFBaUI7U0FDekIsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IEFyZ3VtZW50c0NhbWVsQ2FzZSwgQXJndiwgQ29tbWFuZE1vZHVsZSB9IGZyb20gJ3lhcmdzJztcbmltcG9ydCB7XG4gIEJhY2tlbmRPdXRwdXRDbGllbnQsXG4gIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvcixcbiAgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2RlcGxveWVkLWJhY2tlbmQtY2xpZW50JztcbmltcG9ydCB7IGdyYXBocWxPdXRwdXRLZXkgfSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc2NoZW1hcyc7XG5pbXBvcnQgeyBCYWNrZW5kSWRlbnRpZmllclJlc29sdmVyIH0gZnJvbSAnLi4vLi4vLi4vYmFja2VuZC1pZGVudGlmaWVyL2JhY2tlbmRfaWRlbnRpZmllcl9yZXNvbHZlci5qcyc7XG5pbXBvcnQgeyBERUZBVUxUX1VJX1BBVEggfSBmcm9tICcuLi8uLi8uLi9mb3JtLWdlbmVyYXRpb24vZGVmYXVsdF9mb3JtX2dlbmVyYXRpb25fb3V0cHV0X3BhdGhzLmpzJztcbmltcG9ydCB7IEZvcm1HZW5lcmF0aW9uSGFuZGxlciB9IGZyb20gJy4uLy4uLy4uL2Zvcm0tZ2VuZXJhdGlvbi9mb3JtX2dlbmVyYXRpb25faGFuZGxlci5qcyc7XG5pbXBvcnQgeyBBcmd1bWVudHNLZWJhYkNhc2UgfSBmcm9tICcuLi8uLi8uLi9rZWJhYl9jYXNlLmpzJztcbmltcG9ydCB7IEFtcGxpZnlVc2VyRXJyb3IgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5cbmV4cG9ydCB0eXBlIEdlbmVyYXRlRm9ybXNDb21tYW5kT3B0aW9ucyA9XG4gIEFyZ3VtZW50c0tlYmFiQ2FzZTxHZW5lcmF0ZUZvcm1zQ29tbWFuZE9wdGlvbnNDYW1lbENhc2U+O1xuXG50eXBlIEdlbmVyYXRlRm9ybXNDb21tYW5kT3B0aW9uc0NhbWVsQ2FzZSA9IHtcbiAgc3RhY2s6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgYXBwSWQ6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgYnJhbmNoOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIG91dERpcjogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBtb2RlbHM6IHN0cmluZ1tdIHwgdW5kZWZpbmVkO1xufTtcblxuLyoqXG4gKiBDb21tYW5kIHRoYXQgZ2VuZXJhdGVzIFVJIGZvcm1zLlxuICovXG5leHBvcnQgY2xhc3MgR2VuZXJhdGVGb3Jtc0NvbW1hbmRcbiAgaW1wbGVtZW50cyBDb21tYW5kTW9kdWxlPG9iamVjdCwgR2VuZXJhdGVGb3Jtc0NvbW1hbmRPcHRpb25zPlxue1xuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIHJlYWRvbmx5IGNvbW1hbmQ6IHN0cmluZztcblxuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIHJlYWRvbmx5IGRlc2NyaWJlOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgVUkgZm9ybXMgZ2VuZXJhdGlvbiBjb21tYW5kLlxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBiYWNrZW5kSWRlbnRpZmllclJlc29sdmVyOiBCYWNrZW5kSWRlbnRpZmllclJlc29sdmVyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYmFja2VuZE91dHB1dENsaWVudEJ1aWxkZXI6ICgpID0+IEJhY2tlbmRPdXRwdXRDbGllbnQsXG4gICAgcHJpdmF0ZSByZWFkb25seSBmb3JtR2VuZXJhdGlvbkhhbmRsZXI6IEZvcm1HZW5lcmF0aW9uSGFuZGxlclxuICApIHtcbiAgICB0aGlzLmNvbW1hbmQgPSAnZm9ybXMnO1xuICAgIHRoaXMuZGVzY3JpYmUgPSAnR2VuZXJhdGVzIFVJIGZvcm1zJztcbiAgfVxuXG4gIGdldEJhY2tlbmRJZGVudGlmaWVyID0gYXN5bmMgKGFyZ3M6IEdlbmVyYXRlRm9ybXNDb21tYW5kT3B0aW9ucykgPT4ge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmJhY2tlbmRJZGVudGlmaWVyUmVzb2x2ZXIucmVzb2x2ZURlcGxveWVkQmFja2VuZElkZW50aWZpZXIoXG4gICAgICBhcmdzXG4gICAgKTtcbiAgfTtcblxuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIGhhbmRsZXIgPSBhc3luYyAoXG4gICAgYXJnczogQXJndW1lbnRzQ2FtZWxDYXNlPEdlbmVyYXRlRm9ybXNDb21tYW5kT3B0aW9ucz5cbiAgKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgY29uc3QgYmFja2VuZElkZW50aWZpZXIgPVxuICAgICAgYXdhaXQgdGhpcy5iYWNrZW5kSWRlbnRpZmllclJlc29sdmVyLnJlc29sdmVEZXBsb3llZEJhY2tlbmRJZGVudGlmaWVyKFxuICAgICAgICBhcmdzXG4gICAgICApO1xuXG4gICAgaWYgKCFiYWNrZW5kSWRlbnRpZmllcikge1xuICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoJ0JhY2tlbmRJZGVudGlmaWVyUmVzb2x2ZXJFcnJvcicsIHtcbiAgICAgICAgbWVzc2FnZTogJ0NvdWxkIG5vdCByZXNvbHZlIHRoZSBiYWNrZW5kIGlkZW50aWZpZXIuJyxcbiAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAnRW5zdXJlIHN0YWNrIG5hbWUgb3IgQW1wbGlmeSBBcHAgSUQgYW5kIGJyYW5jaCBzcGVjaWZpZWQgYXJlIGNvcnJlY3QgYW5kIGV4aXN0cywgdGhlbiByZS1ydW4gdGhpcyBjb21tYW5kLicsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBiYWNrZW5kT3V0cHV0Q2xpZW50ID0gdGhpcy5iYWNrZW5kT3V0cHV0Q2xpZW50QnVpbGRlcigpO1xuXG4gICAgbGV0IG91dHB1dDtcbiAgICB0cnkge1xuICAgICAgb3V0cHV0ID0gYXdhaXQgYmFja2VuZE91dHB1dENsaWVudC5nZXRPdXRwdXQoYmFja2VuZElkZW50aWZpZXIpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoXG4gICAgICAgIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvci5pc0JhY2tlbmRPdXRwdXRDbGllbnRFcnJvcihlcnJvcikgJiZcbiAgICAgICAgZXJyb3IuY29kZSA9PT0gQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5ERVBMT1lNRU5UX0lOX1BST0dSRVNTXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICAgJ0RlcGxveW1lbnRJblByb2dyZXNzRXJyb3InLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdEZXBsb3ltZW50IGlzIGN1cnJlbnRseSBpbiBwcm9ncmVzcy4nLFxuICAgICAgICAgICAgcmVzb2x1dGlvbjogJ1JlLXJ1biB0aGlzIGNvbW1hbmQgb25jZSB0aGUgZGVwbG95bWVudCBjb21wbGV0ZXMuJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGVycm9yXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoXG4gICAgICAgIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvci5pc0JhY2tlbmRPdXRwdXRDbGllbnRFcnJvcihlcnJvcikgJiZcbiAgICAgICAgZXJyb3IuY29kZSA9PT0gQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5OT19TVEFDS19GT1VORFxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAgICdTdGFja0RvZXNOb3RFeGlzdEVycm9yJyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBtZXNzYWdlOiAnU3RhY2sgZG9lcyBub3QgZXhpc3QuJyxcbiAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICdFbnN1cmUgdGhlIENsb3VkRm9ybWF0aW9uIHN0YWNrIElEIG9yIEFtcGxpZnkgQXBwIElEIGFuZCBicmFuY2ggc3BlY2lmaWVkIGFyZSBjb3JyZWN0IGFuZCBleGlzdHMsIHRoZW4gcmUtcnVuIHRoaXMgY29tbWFuZC4nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZXJyb3JcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChcbiAgICAgICAgQmFja2VuZE91dHB1dENsaWVudEVycm9yLmlzQmFja2VuZE91dHB1dENsaWVudEVycm9yKGVycm9yKSAmJlxuICAgICAgICBlcnJvci5jb2RlID09PSBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLkNSRURFTlRJQUxTX0VSUk9SXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICAgJ0NyZWRlbnRpYWxzRXJyb3InLFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgICAgICdVbmFibGUgdG8gZ2V0IGJhY2tlbmQgb3V0cHV0cyBkdWUgdG8gaW52YWxpZCBjcmVkZW50aWFscy4nLFxuICAgICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICAgJ0Vuc3VyZSB5b3VyIEFXUyBjcmVkZW50aWFscyBhcmUgY29ycmVjdGx5IHNldCBhbmQgcmVmcmVzaGVkLicsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBlcnJvclxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKFxuICAgICAgICBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IuaXNCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IoZXJyb3IpICYmXG4gICAgICAgIGVycm9yLmNvZGUgPT09IEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUuQUNDRVNTX0RFTklFRFxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAgICdBY2Nlc3NEZW5pZWRFcnJvcicsXG4gICAgICAgICAge1xuICAgICAgICAgICAgbWVzc2FnZTpcbiAgICAgICAgICAgICAgJ1VuYWJsZSB0byBnZXQgYmFja2VuZCBvdXRwdXRzIGR1ZSB0byBpbnN1ZmZpY2llbnQgcGVybWlzc2lvbnMuJyxcbiAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICdFbnN1cmUgeW91IGhhdmUgcGVybWlzc2lvbnMgdG8gY2FsbCBjbG91ZGZvcm1hdGlvbjpHZXRUZW1wbGF0ZVN1bW1hcnkuJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGVycm9yXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cblxuICAgIGlmICghKGdyYXBocWxPdXRwdXRLZXkgaW4gb3V0cHV0KSB8fCAhb3V0cHV0W2dyYXBocWxPdXRwdXRLZXldKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIEdyYXBoUUwgQVBJIGNvbmZpZ3VyZWQgZm9yIHRoaXMgYmFja2VuZC4nKTtcbiAgICB9XG5cbiAgICBjb25zdCBhcGlVcmwgPSBvdXRwdXRbZ3JhcGhxbE91dHB1dEtleV0ucGF5bG9hZC5hbXBsaWZ5QXBpTW9kZWxTY2hlbWFTM1VyaTtcblxuICAgIGlmICghYXJncy5vdXREaXIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignb3V0LWRpciBtdXN0IGJlIGRlZmluZWQnKTtcbiAgICB9XG5cbiAgICBjb25zdCBvdXREaXIgPSBhcmdzLm91dERpcjtcblxuICAgIGF3YWl0IHRoaXMuZm9ybUdlbmVyYXRpb25IYW5kbGVyLmdlbmVyYXRlKHtcbiAgICAgIG1vZGVsc091dERpcjogcGF0aC5qb2luKG91dERpciwgJ2dyYXBocWwnKSxcbiAgICAgIGJhY2tlbmRJZGVudGlmaWVyLFxuICAgICAgdWlPdXREaXI6IG91dERpcixcbiAgICAgIGFwaVVybCxcbiAgICAgIG1vZGVsc0ZpbHRlcjogYXJncy5tb2RlbHMsXG4gICAgfSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICBidWlsZGVyID0gKHlhcmdzOiBBcmd2KTogQXJndjxHZW5lcmF0ZUZvcm1zQ29tbWFuZE9wdGlvbnM+ID0+IHtcbiAgICByZXR1cm4geWFyZ3NcbiAgICAgIC5vcHRpb24oJ3N0YWNrJywge1xuICAgICAgICBjb25mbGljdHM6IFsnYXBwLWlkJywgJ2JyYW5jaCddLFxuICAgICAgICBkZXNjcmliZTogJ0Egc3RhY2sgbmFtZSB0aGF0IGNvbnRhaW5zIGFuIEFtcGxpZnkgYmFja2VuZCcsXG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgIGdyb3VwOiAnU3RhY2sgaWRlbnRpZmllcicsXG4gICAgICB9KVxuICAgICAgLm9wdGlvbignYXBwLWlkJywge1xuICAgICAgICBjb25mbGljdHM6IFsnc3RhY2snXSxcbiAgICAgICAgZGVzY3JpYmU6ICdUaGUgQW1wbGlmeSBBcHAgSUQgb2YgdGhlIHByb2plY3QnLFxuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICBpbXBsaWVzOiAnYnJhbmNoJyxcbiAgICAgICAgZ3JvdXA6ICdQcm9qZWN0IGlkZW50aWZpZXInLFxuICAgICAgfSlcbiAgICAgIC5vcHRpb24oJ2JyYW5jaCcsIHtcbiAgICAgICAgY29uZmxpY3RzOiBbJ3N0YWNrJ10sXG4gICAgICAgIGRlc2NyaWJlOiAnQSBnaXQgYnJhbmNoIG9mIHRoZSBBbXBsaWZ5IHByb2plY3QnLFxuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICBncm91cDogJ1Byb2plY3QgaWRlbnRpZmllcicsXG4gICAgICAgIGltcGxpZXM6ICdhcHBJZCcsXG4gICAgICB9KVxuICAgICAgLm9wdGlvbignb3V0LWRpcicsIHtcbiAgICAgICAgZGVzY3JpYmU6ICdBIHBhdGggdG8gZGlyZWN0b3J5IHdoZXJlIGdlbmVyYXRlZCBmb3JtcyBhcmUgd3JpdHRlbi4nLFxuICAgICAgICBkZWZhdWx0OiBERUZBVUxUX1VJX1BBVEgsXG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgIGdyb3VwOiAnRm9ybSBHZW5lcmF0aW9uJyxcbiAgICAgIH0pXG4gICAgICAub3B0aW9uKCdtb2RlbHMnLCB7XG4gICAgICAgIGRlc2NyaWJlOiAnTW9kZWwgbmFtZSB0byBnZW5lcmF0ZScsXG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICBhcnJheTogdHJ1ZSxcbiAgICAgICAgZ3JvdXA6ICdGb3JtIEdlbmVyYXRpb24nLFxuICAgICAgfSk7XG4gIH07XG59XG4iXX0=